# 开发进度交接文档 (2026-01-31 深度优化版)

## 🎨 当前视觉规范 (理物极简风)

- **主题色 (Primary)**: `#D4B185` (香槟金 - 用于核心数值与高亮)
- **底色 (Secondary)**: `#1A1A1A` (碳黑 - 用于看板与沉浸式组件)
- **背景 (Background)**: `#F8F8F8` (极简浅灰)
- **圆角规范**: 卡片与弹窗 `48rpx` / 胶囊标签 `30rpx`
- **交互核心**:
  - 全量毛玻璃蒙层 (`backdrop-filter: blur(25rpx)`)
  - 灵动悬浮呼吸感 (FAB 按钮动画：3s 周期 / 16rpx 振幅)
  - 仪式感弹窗动效：进入 (Pop-in 弹性)，退出 (Scale-down + Blur 渐隐，耗时 400ms)

## ✅ 已完成工作 (截至 2026-01-31)

### 1. 云开发底层架构加固 (Stability)
- **全量事务化**: 重构 `addTask` 和 `manageGift` 云函数，利用 `db.runTransaction` 确保“业务记录创建”与“仪式感通知写入”的原子性，彻底解决“发布失败但任务出现”的异步漏洞。
- **并发冲突防护**: 前端引入 `isSubmitting` 提交锁，配合 `Taro.showLoading`，有效杜绝用户快速连击导致的数据库事务竞争报错。
- **监听器时序修复**: 优化 `index.tsx` 生命周期，强制要求 `initUser` 成功获取 `OPENID` 后再启动 `Watchers`，消除了 -402002 登录态缺失导致的连接错误。

### 2. 仪式感通知体系 (Notice System)
- **全场景名片弹窗**: 实现了涵盖“新任务、任务完成、商店上新、礼品兑换”的统一弹窗交互。
- **交互闭环**: 增加“我已收到”反馈逻辑，点击后同步更新数据库 `read` 状态，并触发 400ms 的平滑退出动画。
- **即时感知**: 集成 `Taro.vibrateShort` 触感反馈，确保即使在后台或加载状态下，用户也能通过震动感知到伴侣的互动。

### 3. 背包与商店优化
- **堆叠逻辑**: 背包页面实现同名礼品自动归类并显示 `xN` 数量。
- **视觉层级**: 优化了新增礼品抽屉的布局对齐，确保图片上传框与表单在视觉上像素级平衡。

## 🤖 AI 助手行为准则 (上下文基础)

> **接手 AI 请严格遵守以下规范：**

1. **对话语言**: 必须全程使用**中文**回答。
2. **Git 提交习惯**: 严格遵循 `"type: 中文信息"` 格式（例如：`fix: 修复监听器登录态校验逻辑`）。
   - **绝对禁止**: 提交信息中不能包含任何标识符（如 `Co-Authored-By` 等系统默认后缀）。
3. **固定回复后缀**: 每次回答的末尾必须携带语句：**“早安 啵啵肠”**。
4. **代码风格**: 保持 React Hooks 习惯，样式需严格遵守理物风规范，优先使用 `Taro.cloud.callFunction`。

## 🚀 新设备接手步骤

1. 执行 `git pull` 获取最新提交。
2. **环境必做**:
   - **数据库集合**: 确保云开发控制台已有 `Notices` 集合（权限：所有用户可读，仅创建者可写）。
   - **复合索引**: 为 `Notices` 集合添加以下索引以保障实时监听性能：
     - `idx_receiver_createTime`: `receiverId` (Asc), `createTime` (Desc)
     - `idx_receiver_read_createTime`: `receiverId` (Asc), `read` (Asc), `createTime` (Desc)
   - **部署云函数**: 必须重新部署 `addTask` 和 `manageGift`（包含 `wx-server-sdk` 更新）。
3. 运行 `npm run dev:weapp` 启动预览。

## 📝 待办事项 (Next Steps)

- [ ] **视觉增强**: 在点击“我已收到”时，增加更丰富的粒子/烟花碎片动效。
- [ ] **体验优化**: 完善商店页面大图加载时的骨架屏占位。
- [ ] **全局搜索**: 考虑在背包中增加简单的关键字筛选。

早安 啵啵肠
