# 微信订阅消息集成设计方案 (2026-02-02)

## 1. 概述
本文档旨在为“Ours”双人小程序设计并集成微信订阅消息系统，实现当伴侣进行核心交互（发布任务、完成任务、使用礼品）时，另一方能在微信外部接收到实时提醒。遵循“理物极简风”规范，排除低频或系统性通知（如新增礼品）。

## 2. 场景定义 (全场景交互)
| 触发动作 | 接收人 | 消息内容示例 | 字段设计 (占位) |
| :--- | :--- | :--- | :--- |
| **发布新任务** | 对方 | “XXX 给你发布了一个新任务，快去看看吧” | `thing1`: 任务名称, `name2`: 发布人, `time3`: 发布时间 |
| **完成任务** | 对方 | “XXX 已完成你发布的任务：洗碗，积分已发放” | `thing1`: 任务名称, `phrase2`: 已完成, `time3`: 完成时间 |
| **使用礼品** | 对方 | “XXX 使用了礼品：按摩券，请及时兑现哦” | `thing1`: 礼品名称, `name2`: 使用人, `time3`: 使用时间 |

## 3. 架构设计

### 3.1 前端：订阅管理器 (`src/utils/subscribe.ts`)
- **功能**：封装 `Taro.requestSubscribeMessage` 调用。
- **策略**：**动作跟随型**。在业务成功（如发布成功）的回调中触发授权弹窗。
- **配置化**：定义 `MSG_ID_MAP` 常量，预留模板 ID 占位符。

### 3.2 后端：推送服务 (`cloudfunctions/common/msgSender.js`)
- **功能**：封装 `cloud.openapi.subscribeMessage.send`。
- **解耦**：业务云函数仅需调用 `msgSender`，无需关注微信 API 的复杂参数。
- **精准推送**：自动通过 `partnerId` 确定 `touser` OpenID。

## 4. 实施路径
1. **云权限开启**：更新涉及云函数的 `config.json`，授权 `subscribeMessage.send`。
2. **工具类开发**：创建前端 `subscribe.ts` 与后端 `msgSender.js`。
3. **前端注入**：在 `index.tsx`（首页任务）与 `store/inventory`（礼品使用）中注入订阅引导。
4. **后端联动**：在 `addTask`、`updateTaskStatus`、`useItem` 云函数末尾触发推送。

## 5. 验收标准
- [ ] 用户执行动作后，业务逻辑不受推送成败影响。
- [ ] 授权弹窗仅在成功操作后出现。
- [ ] 对方能收到对应的微信服务通知。

---
*Generated by Claude Code - 理物极简风设计规范认证*
